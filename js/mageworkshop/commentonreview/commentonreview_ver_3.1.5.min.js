!function(a){"use strict";a.fn.commentOnReview=function(b){var c=function(){a.extend(!0,this.options,b),this.bindEvent(),this.wrapNicknameToSpan()};return c.prototype.options={saveReplyUrl:null,delayOfMessageDisplaying:8e3,emptyDetailMessage:"Please enter text of the reply",isMainReview:!1,showElements:2,isCaptchaEnabled:!1,checkCaptchaUrl:"",queryParams:{entity_pk_value:null,nickname:null,title:null},minDetailLength:1,maxDetailLength:2e3,detailErrorMessages:{emptyDetail:"Please enter text of the reply",lengthDetail:"Reply must be min 1 and max 2000 characters"},nicknameSuffix:"@",defaultFailMessage:"Something went wrong."},c.prototype.bindEvent=function(){a(document).on("click",".reply-button",{that:this},this.showReplyBlock),a(document).on("click",".reply-cancel-button",{that:this},this.hideReplyBlock),a(document).on("click",".reply-submit-button",{that:this},this.saveReplyAjax)},c.prototype.showReplyBlock=function(b){var c=b.data.that,d=a(".reply-wrapper"),e=a(this);c.options.isMainReview=e.hasClass("reply-review");var f=c.getAuthorName(e);c.options.queryParams.authorName=f,a(".reply-message").html(""),a(".reply-captcha-wrapper .captcha-error").html("");var g=a(".reply-comment");g.removeClass("error-detail").html('<span id="reply-comment-nickname" class="reply-comment-nickname" contenteditable="false">'+f+"</span>"),c.options.isMainReview?e.closest(".reply-action").after(d):e.closest(".reply-action-wrapper").after(d),d.removeClass("reply-hide").addClass("reply-show"),g.focus(),/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream&&g[0].scrollIntoView(!0),c.setFocusAfterNickname()},c.prototype.setFocusAfterNickname=function(){setTimeout(function(){var a,b,c=document.getElementById("reply-comment-nickname");if(a=window.getSelection?window.getSelection():document.selection.createRange().text,a.getRangeAt&&a.rangeCount){b=a.getRangeAt(0),b.deleteContents();var d=document.createTextNode("Â ");b.setStartAfter(c),b.insertNode(d),b.setStartAfter(d),b.collapse(!0),a=window.getSelection(),a.removeAllRanges(),a.addRange(b)}},10)},c.prototype.hideReplyBlock=function(){a(".reply-wrapper, .reply-message-wrapper").removeClass("reply-show").addClass("reply-hide"),a(".reply-message").html("")},c.prototype.saveReplyAjax=function(b){var c=b.data.that,d=a(this);c.options.queryParams.entity_pk_value=d.closest(".review-dd").find(".review-id").val(),c.options.queryParams.title=d.closest(".review-dd").find(".title:first").text(),c.options.queryParams.detail=d.closest(".reply-wrapper").find(".reply-comment").text(),c.options.queryParams.isMainReview&&(c.options.queryParams.nickname=c.getAuthorName(b));var e=c.validate(c.options.queryParams.detail,d);if(e.status===!0)if(a(".reply-message-wrapper").removeClass("reply-show").addClass("reply-hide"),a(".reply-wrapper .reply-comment-wrapper .reply-comment").removeClass("error-detail"),c.options.isCaptchaEnabled){var f=c.checkRecaptcha();f&&c.replyAjax(d)}else c.replyAjax(d);else c.generateErrorMessage(e.message)},c.prototype.validate=function(a,b){var c=this,d=[];d.status=!1;var e=c.deleteAuthorName(a,b);return Boolean(e)?c.validateDetailLength(e)?(d.status=!0,d):(d.message=c.options.detailErrorMessages.lengthDetail,d):(d.message=c.options.detailErrorMessages.emptyDetail,d)},c.prototype.getAuthorName=function(b){var c=this.options.nicknameSuffix;if(this.options.isMainReview){if(c+=a(b.closest(".item-review-wrapper")).find(".review-dt .nickname").text().trim(),/\s/g.test(c)){var d=c.substr(c.indexOf(" ")+1);c=c.substr(0,c.indexOf(" ")),d=d.match(/\b(\w)/g),d=d.join(""),c+=d}}else c+=a(b.closest(".reply-wrap")).find(".reply-author").text();return c},c.prototype.deleteAuthorName=function(a,b){return a.trim().replace(this.getAuthorName(b),"").trim()},c.prototype.validateDetailLength=function(a){var b=this;return a.length>=b.options.minDetailLength&&a.length<=b.options.maxDetailLength},c.prototype.replyAjax=function(b){var c=this,d=c.options.queryParams;d.detail.includes(d.authorName)||(d.detail=d.authorName+" "+d.detail),a.ajax({url:c.options.saveReplyUrl,data:d}).done(function(d){var e=a(b.closest(".reply-list-wrap")).find(".reply-list");if(d.html&&e.append(d.html),c.manageReplyDisplay(e),c.hideReplyBlock(),d.html){var f=a(b.closest(".reply-list-wrap")).find(".reply-count");f.text(parseInt(f.text())+1)}var g=document.createEvent("CustomEvent");g.initEvent("updateDateDR",!1,!0),window.dispatchEvent(g)}).fail(function(){new PNotify({text:c.options.defaultFailMessage,type:"error",delay:c.options.delayOfMessageDisplaying})}).complete(function(b){b=a.parseJSON(b.responseText),new PNotify({text:c.wrapMessages(b.messages),type:b.type,delay:c.options.delayOfMessageDisplaying})})},c.prototype.manageReplyDisplay=function(a){var b=a.find(".reply").last();if(a.find(".reply").length>this.options.showElements){var c=a.closest(".reply-list-wrap").find(".reply-expander");c.addClass("show"),c.hasClass("collapse")&&b.addClass("expanded")}else b.addClass("expanded")},c.prototype.generateErrorMessage=function(b){var c=a(".reply-message-wrapper");a(".reply-wrapper .reply-comment-wrapper .reply-comment").addClass("error-detail");var d=c.find(".reply-message");d.html("<li>"+b+"</li>").fadeIn(200),c.removeClass("reply-hide").addClass("reply-show")},c.prototype.checkRecaptcha=function(){var b=this,c=a("#reply-form"),d=!1;return a.ajax({url:b.options.checkCaptchaUrl,data:c.serialize(),async:!1,success:function(b){"invalid"==b?(a(".captcha-error").html("You have entered wrong captcha"),grecaptcha.reset()):(a(".captcha-error").html(""),d=!0)}}),d},c.prototype.wrapNicknameToSpan=function(){a(".reply-list-wrap .reply-wrap .reply-info .reply-detail").each(function(){var b=a(this).text().trim(),c='<span class="reply-comment-nickname" contenteditable="false">'+b.replace(/\u00A0/g," ").replace(" ","</span> ");a(this).html(c)})},c.prototype.wrapMessages=function(a){var b="";for(var c in a)a.hasOwnProperty(c)&&(b+="<p>"+a[c]+"</p>");return b},new c(b)},a.fn.CommentExpander=function(b){var c=function(){a.extend(!0,this.options,b),this.bindEvent()};return c.prototype.options={showElements:2,classz:{replyWrapper:".reply-list-wrap",replyList:".reply-list"}},c.prototype.bindEvent=function(){a(document).on("click",".reply-show-hide",{that:this},this.expandComment)},c.prototype.expandComment=function(b){var c=b.data.that,d=a(this),e=d.closest(c.options.classz.replyWrapper).find(c.options.classz.replyList),f=e.find(".reply"),g=c.options.showElements,h=d.closest(".reply-expander");e.hasClass("open")?(e.removeClass("open"),f.slice(g,f.length).removeClass("expanded"),h.removeClass("collapse").addClass("expand")):(e.addClass("open"),f.slice(g,f.length).addClass("expanded"),h.removeClass("expand").addClass("collapse"))},new c(b)}}(DRjQuery);
