!function(a){"use strict";a.fn.ajaxLoad=function(b){var c=function(b){a.extend(!0,this.options,b),this.hasIdReview(),this.bindEvent(),this.getRatingStyles(drConfig)};return c.prototype.options={ajaxErrorMessage:"Error, contact customer support.",ajaxErrorTemplate:'<ul class="messages"><li class="notice-msg"><ul><li><span>{{ajaxErrorMessage}}</span></li></ul></li></ul>',clearFiltersMessage:"Clear all filters",clearFiltersTemplate:'<span><a class="clear-filters-link" href="javascript:void(0)" >{{clearFiltersMessage}}</a></span>',clearFiltersCssClass:".clear-filters-link",clearFiltersArray:["keywords","images","video","highest_contributors","verified_buyers","admin_response"],container:"#customer-reviews",filters:{checkboxes:'input[data-type="review-filter"]',limit:'.limiter select[data-type="limiter"]',page:'.pages a[data-type="r-page"]',ranges:'a[data-type="range-filter"]',searchForm:"#review_search_mini_form",selectSort:'.review-sorts select[data-type="sort"]',tabsSort:'li[data-type="sort"]',sortsSpan:".top-dropdown-sorts a",dateFilterSpan:".review-date-filters .top-title"},queryParams:{sort:"date_desc",range:null,keywords:null,images:null,video:null,highest_contributors:null,verified_buyers:null,admin_response:null,r_p:null,r_limit:null,r_id:null,product_id:null},url:null},c.prototype.clearFilters=function(b){var c=b.data.that;a.each(c.options.clearFiltersArray,function(a,b){c.options.queryParams[b]=null}),c.ajaxLoad(),a(c.options.filters.checkboxes).removeAttr("checked"),a(c.options.filters.searchForm).find("#review-search").val("")},c.prototype.hasIdReview=function(){var a=this;if(window.location.hash){var b=window.location.hash;if("#rw_"===b.replace(/[0-9]/g,"")){this.options.queryParams.r_id=b.match(/\d+/)[0];var c=this.ajaxLoad();c.success(function(){a.scrollToEl(b)})}}},c.prototype.scrollToEl=function(b){var c=a(b).parent(),d=a(b).offset(),e=a(window).height();if(c){var f=c.css("background-color");c.css("background-color","#ffffcc")}var g=a("html, body");a(window).bind("scroll mousedown DOMMouseScroll mousewheel keyup",function(a){(a.which>0||"mousedown"===a.type||"mousewheel"===a.type)&&g.stop().unbind("scroll mousedown DOMMouseScroll mousewheel keyup")}),d&&setTimeout(function(){g.animate({scrollTop:d.top-e/2},"slow")},1e3),f&&c.animate({backgroundColor:f},8e3)},c.prototype.removeHashUrl=function(){a.browser.msie&&a.browser.version<=9?window.location=document.URL.replace(/#.*$/,""):history.replaceState({},document.title,document.URL.replace(/#.*$/,""))},c.prototype.removeClearFiltersLink=function(){var b=this,c=!0;a.each(this.options.clearFiltersArray,function(a,d){if(b.options.queryParams[d])return c=!1,!1}),c&&a(this.options.clearFiltersCssClass).parents("span").remove()},c.prototype.addClearFilters=function(){a(this.options.clearFiltersCssClass).length||a(this.options.filters.searchForm).after(this.options.clearFiltersTemplate.replace("{{clearFiltersMessage}}",this.options.clearFiltersMessage))},c.prototype.bindEvent=function(){a(this.options.filters.tabsSort).on("click",{that:this},this.prepareAjaxLoad),a(this.options.filters.selectSort).change({that:this},this.prepareAjaxLoad),a(this.options.filters.ranges).on("click",{that:this},this.prepareAjaxLoad),a(this.options.filters.checkboxes).change({that:this},this.prepareAjaxLoad),a(this.options.filters.searchForm).submit({that:this},this.prepareAjaxLoad),a(this.options.filters.limit).change({that:this},this.prepareAjaxLoad),a(this.options.filters.page).on("click",{that:this},this.prepareAjaxLoad),a(this.options.clearFiltersCssClass).on("click",{that:this},this.clearFilters)},c.prototype.unbindEvent=function(){a.each(this.options.filters,function(b,c){a(c).unbind()})},c.prototype.switchTab=function(b){a(this.options.filters.tabsSort).removeClass("selected"),a(this.options.filters.tabsSort).closest("ul").css("height","40px"),a(b).addClass("selected"),a(this.options.filters.sortsSpan).text(a(b).text())},c.prototype.switchRange=function(b){a(b).closest("ul").css("height","40px"),a(this.options.filters.dateFilterSpan).text(a(b).text())},c.prototype.updateParams=function(b){var c=a(b).data("type");switch(c){case"sort":this.options.queryParams.sort=a(b).is("select")?a(b).val():a(b).data("sort");break;case"range-filter":this.options.queryParams.range=a(b).data("value");break;case"review-filter":this.options.queryParams[a(b).data("filter")]=a(b).prop("checked")?1:0;break;case"search":this.options.queryParams.keywords=a(b).find(".input-text").val().trim();break;case"limiter":this.options.queryParams.r_limit=a(b).val();break;case"r-page":this.options.queryParams.r_p=a(b).data("number")}a.inArray(c,["review-filter","search"])>=0&&this.addClearFilters(),a.inArray(c,["sort","limiter","r-page"])===-1&&(this.options.queryParams.r_p=null)},c.prototype.prepareAjaxLoad=function(b){var c=b.data.that||null;if("submit"===b.type&&a(this).find("#review-search").val().length<=0)return new PNotify({text:"Search form is empty.",icon:!1,delay:5e3}),!1;"sort"!==a(this).data("type")||a(this).is("select")||c.switchTab(this),"range-filter"===a(this).data("type")&&c.switchRange(this),c.updateParams(this);var d=a(".reply-wrapper");return d.closest(".reply-list-wrap").length&&a("#customer-reviews").after(d.removeClass("reply-show").addClass("reply-hide")),c.ajaxLoad(),!1},c.prototype.ajaxLoad=function(){var b=this;this.unbindEvent();var c;return c=a.ajax({url:this.options.url,dataType:"json",data:this.options.queryParams}).done(function(c){var d=a(document).find(b.options.container).length>0?a(document).find(b.options.container):a(".reviews-container ul.messages");if(d.siblings(".complaint-list-wrapper").remove(),d.replaceWith(c.html),b.shortText(drConfig),b.getRatingStyles(drConfig),c.hasOwnProperty("reviewsCount")){a.each(c.reviewsCount,function(b,c){a('a[data-type="range-filter"][data-value='+b+"]").find("span > span").html(" ("+c+")")});var e=a('a[href="#product_tabs_review_tabbed"]');if(e.length){var f=e.text().split("(")[0]+"("+c.reviewsCount[999]+")";e.text(f)}}if(c.hasOwnProperty("countReviewsWithRating")&&c.hasOwnProperty("avgRating")){var g="";if(1==c.countReviewsWithRating?g=c.countReviewsWithRating+" review":0==c.countReviewsWithRating?(g=c.countReviewsWithRating+" reviews",a(".rating-stars-views").find(".rating").css("width","0%")):g=c.countReviewsWithRating+" reviews",a(".average-based-on").html(g),a(".rating-stars-views").find(".rating").css("width",Math.round(c.avgRating/c.countReviewsWithRating*20)+"%"),c.hasOwnProperty("qtyMarks")&&a(document).find(".separate-rating").length>0){var h=5;a(".separate-rating").children(".mark-rating").each(function(){c.avgRating>0?(a(this).find(".scroll-rating").css("width",Math.round(c.qtyMarks[h]/c.countReviewsWithRating*100)+"%"),a(this).find(".rating-percent span").html(c.qtyMarks[h])):(a(this).find(".scroll-rating").css("width","0"),a(this).find(".rating-percent span").html("0")),h--})}}if(c.hasOwnProperty("averageSizing")){var i=a(".sizing-bar.average");c.averageSizing&&(i.find("div").css("width",c.averageSizing.optionWidth+"%"),i.find(".sizing-pointer").css("margin-left",c.averageSizing.optionWidth+"%"),i.find(".sizing-label").css("margin-left",c.averageSizing.optionWidth+"%"),i.find(".sizing-label").css("right",c.averageSizing.indent),i.find(".sizing-label").html(c.averageSizing.optionValue))}b.hasIdReview(),b.options.queryParams.r_id&&(b.options.queryParams.r_id=null,setTimeout(function(){b.removeHashUrl()},1e3));var j;document.createEvent&&(j=document.createEvent("CustomEvent"),j.initEvent("updateDateDR",!1,!0),window.dispatchEvent(j))}).fail(function(){a(b.options.container).html(b.options.ajaxErrorTemplate.replace("{{ajaxErrorMessage}}",b.options.ajaxErrorMessage))}).complete(function(){b.removeClearFiltersLink(),b.bindEvent()})},c.prototype.getRatingStyles=function(b){a(".reviews-container .ratings-table .rating-box").css("background","url("+b.unActiveImageSeparate+") repeat-x"),a(".reviews-container .ratings-table .rating-box .rating").css("background","url("+b.activeImageSeparate+") repeat-x"),a(".review-top .average-rating .rating-box").css("background-image","url("+b.unActiveImageAverage+")"),a(".review-top .average-rating .rating-box .rating").css("background-image","url("+b.activeImageAverage+")"),a(".overall-raiting .overall-raiting-value li .separate-rating-star").css("background","url("+b.unActiveImageAverage+") no-repeat"),a(".category-products .ratings .amount").css("float","left")},c.prototype.shortText=function(b){a(b.shortTextClass).each(function(){var c=a(this).html(),d=b.shortTextSize;if(c.length>d){var e=c.substr(0,d),f=c.substr(d-1,c.length-d),g=e+'<span class="more">...&nbsp;</span><span class="'+b.moreTextClass+'"><span>'+f+'</span>&nbsp;&nbsp;<a href="" class="'+b.moreLink+'">'+b.moreText+"</a></span>";a(this).html(g)}})},new c(b)}}(DRjQuery);
